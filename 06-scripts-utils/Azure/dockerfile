# Use Ubuntu as base image
FROM ubuntu:22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV TF_VERSION=1.9.8
ENV AZURE_CLI_VERSION=2.65.0

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    unzip \
    gnupg \
    software-properties-common \
    apt-transport-https \
    lsb-release \
    ca-certificates \
    git \
    vim \
    jq \
    python3 \
    python3-pip \
    python3-venv \
    bash-completion \
    && rm -rf /var/lib/apt/lists/*

# Install Azure CLI
RUN curl -sL https://aka.ms/InstallAzureCLIDeb | bash

# Install Azure SDK for Python packages
RUN pip3 install --no-cache-dir \
    azure-identity \
    azure-mgmt-resource \
    azure-mgmt-compute \
    azure-mgmt-storage \
    azure-mgmt-keyvault \
    azure-mgmt-network \
    azure-mgmt-subscription \
    azure-storage-blob \
    azure-storage-file-share \
    azure-storage-queue \
    azure-keyvault-secrets \
    azure-keyvault-keys \
    azure-keyvault-certificates

# RUN az extension add --name azure-cli-ml
# Install Terraform
RUN wget https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip \
    && unzip terraform_${TF_VERSION}_linux_amd64.zip \
    && mv terraform /usr/local/bin/ \
    && rm terraform_${TF_VERSION}_linux_amd64.zip

# Create working directory
WORKDIR /workspace

# Create directories for persistent data
RUN mkdir -p /root/.azure /root/.terraform.d

# Set up bash completion for Azure CLI and Terraform
RUN echo 'source /etc/bash_completion.d/azure-cli' >> /root/.bashrc
RUN terraform -install-autocomplete

# Default command
CMD ["bash"]